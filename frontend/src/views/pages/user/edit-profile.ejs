<!DOCTYPE html>
<html lang="en">

<head>
  <%- include("../../components/head.ejs") %>
  <script src="/js/user.js"></script>
  <title>GradeAnalyzer | Edit Profile</title>
</head>

<body>
  <%- include("../../components/sidebar.ejs") %>

  <main class="sm:ml-64 p-6">
    <h1 class="text-2xl font-semibold mb-6">Profile</h1>

    <div id="profile" class="bg-background-50 shadow-md rounded-lg p-6">
      <div class="flex flex-col items-center mb-6">
        <!-- Avatar Display -->
        <div onclick="document.getElementById('avatar-input').click()" class="relative w-32 h-32 mb-4">
          <img id="avatar" src="/img/default-avatar.png" alt="User Avatar" class="w-full h-full rounded-full object-cover shadow-lg border-4 border-primary-500">
          <input type="file" id="avatar-input" class="hidden" accept="image/*">
          <span class="absolute bottom-0 right-0 bg-primary-500 text-white text-xs px-2 py-1 rounded-full cursor-pointer">Change</span>
        </div>
        <!-- Name -->
        <input type="text" id="name" class="w-full text-2xl font-semibold text-text text-center border-b-2 border-transparent rounded-lg focus:border-primary-500">
        <!-- Username -->
        <p class="text-primary-500">@<span id="username"></span></p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Email Display -->
        <div class="p-6 bg-gray-50 rounded-lg shadow-md flex items-center">
          <span class="material-icons text-primary-500 mr-4"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 39H44V24V9H24H4V24V39Z" fill="none" stroke="currentColor" stroke-width="4" stroke-linejoin="round" />
              <path d="M4 9L24 24L44 9" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M24 9H4V24" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M44 24V9H24" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            </svg></span>
          <div>
            <p class="text-sm text-primary-700 font-medium">Email</p>
            <p id="email" class="text-text font-semibold"></p>
          </div>
        </div>

        <!-- Country Display -->
        <div class="p-6 bg-gray-50 rounded-lg shadow-md flex items-center">
          <span class="material-icons text-primary-500 mr-4"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M24 44C35.0457 44 44 35.0457 44 24C44 12.9543 35.0457 4 24 4C12.9543 4 4 12.9543 4 24C4 35.0457 12.9543 44 24 44Z" stroke="currentColor" stroke-width="4" />
              <path d="M4 20.8404C7.01485 19.4168 9.24466 19.2185 10.6894 20.2454C12.8566 21.7859 13.1283 28.064 18.0575 25.0635C22.9867 22.063 15.9467 20.8404 17.475 16.4939C19.0033 12.1474 24.0083 15.5237 24.5059 10.7627C24.8375 7.58862 21.0408 6.37413 13.1156 7.11921" stroke="currentColor" stroke-width="4" />
              <path d="M36.0001 8C30.2857 12.9886 28.2899 16.0011 30.0127 17.0373C32.5968 18.5917 33.6933 16.4033 36.8467 17.0373C40.0001 17.6714 39.3173 21.9457 37.6587 21.9457C36.0001 21.9457 27.41 20.8518 27.8427 25.865C28.2753 30.8781 33.4422 31.6203 33.4422 34.4211C33.4422 36.2883 32.299 39.146 30.0127 42.9942" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
              <path d="M6.10449 32.9264C7.01598 32.5288 7.70115 32.2374 8.15999 32.052C12.0071 30.4978 14.8617 30.1314 16.7236 30.953C20.0161 32.4059 18.7503 35.3401 19.7816 36.4211C20.8128 37.5021 23.388 37.1876 23.388 39.244C23.388 40.615 22.9275 42.1637 22.0065 43.8901" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
            </svg></span>
          <div>
            <p class="text-sm text-primary-700 font-medium">Country</p>
            <input type="text" id="country" placeholder="2-letter country code" class="w-full text-text font-semibold border-b-2 border-transparent rounded-lg focus:border-primary-500">
          </div>
        </div>

        <!-- School Display -->
        <div class="p-6 bg-gray-50 rounded-lg shadow-md flex items-center">
          <span class="material-icons text-primary-500 mr-4"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 33C4 31.8954 4.89543 31 6 31H12V24L24 16L36 24V31H42C43.1046 31 44 31.8954 44 33V42C44 43.1046 43.1046 44 42 44H4V33Z" fill="none" stroke="currentColor" stroke-width="4" stroke-linejoin="round" />
              <path d="M24 6V16" stroke="currentColor" stroke-width="4" stroke-linecap="round" />
              <path d="M36 11.9998V5.99984C36 5.99984 34.5 8.99984 30 5.99984C25.5 2.99984 24 5.99984 24 5.99984V11.9998C24 11.9998 25.5 8.99984 30 11.9998C34.5 14.9998 36 11.9998 36 11.9998Z" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M28 44V31H20L20 44" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M18 44L30 44" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            </svg></span>
          <div>
            <p class="text-sm text-primary-700 font-medium">School</p>
            <input type="text" id="school" class="w-full text-text font-semibold border-b-2 border-transparent rounded-lg focus:border-primary-500">
          </div>
        </div>

        <!-- Birthday Display -->
        <div class="p-6 bg-gray-50 rounded-lg shadow-md flex items-center">
          <span class="material-icons text-primary-500 mr-4"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 40H40V24H8V40Z" fill="none" />
              <path d="M40 40H8M40 40H4H8M40 40H44M40 40V24H8V40" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M40 34L36 32L32 34L28 32L24 34L20 32L16 34L12 32L8 34" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M32 24V15" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M24 24V15" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M16 24V15" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M32 10V8" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M24 10V8" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M16 10V8" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M8 24V40" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M40 24V40" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            </svg></span>
          <div>
            <p class="text-sm text-primary-700 font-medium">Birthday</p>
            <input type="date" id="birthday" class="w-full text-text font-semibold border-b-2 border-transparent rounded-lg focus:border-primary-500">
          </div>
        </div>

        <!-- Joined Date Display -->
        <div class="p-6 bg-gray-50 rounded-lg shadow-md flex items-center">
          <span class="material-icons text-primary-500 mr-4"><svg class="w-6 h-6" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M5 19H43V40C43 41.1046 42.1046 42 41 42H7C5.89543 42 5 41.1046 5 40V19Z" fill="none" stroke="currentColor" stroke-width="4" stroke-linejoin="round" />
              <path d="M5 9C5 7.89543 5.89543 7 7 7H41C42.1046 7 43 7.89543 43 9V19H5V9Z" stroke="currentColor" stroke-width="4" stroke-linejoin="round" />
              <path d="M16 4V12" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M32 4V12" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M28 34H34" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M14 34H20" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M28 26H34" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M14 26H20" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
            </svg></span>
          <div>
            <p class="text-sm text-primary-700 font-medium">Joined</p>
            <p id="joined-at" class="text-text font-semibold"></p>
          </div>
        </div>
      </div>

      <!-- Save Changes Button -->
      <div class="mt-8 text-center">
        <button id="update-profile" class="inline-block bg-primary-500 text-white px-8 py-3 rounded-lg shadow-lg hover:bg-primary-400 transition duration-200">
          Save Changes
        </button>
      </div>
    </div>
  </main>

  <script>
    const user = new User(app);

    let profile;

    // Fetch user data on page load
    user.getUser().then((response) => {
      if (response.status === "success") {
        profile = response.data.profile;

        document.getElementById("avatar").src = profile.avatar || "/img/default-avatar.png";
        document.getElementById("name").value = profile.name;
        document.getElementById("username").textContent = response.data.username;
        document.getElementById("email").textContent = response.data.email;
        document.getElementById("school").value = profile.school;
        document.getElementById("birthday").value = new Date(profile.birthday).toISOString().split('T')[0];
        document.getElementById("joined-at").textContent = new Date(response.data.createdAt).toLocaleDateString();

        // Render country emoji
        const countryElement = document.getElementById("country");
        const countryCode = profile.country;
        if (countryCode) {
          countryElement.value = countryCode;
        }
      }
    });

    // Avatar input event listener
    const avatarInput = document.getElementById("avatar-input");
    avatarInput.addEventListener("change", async () => {
      const file = avatarInput.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        document.getElementById("avatar").src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    // Update profile button event listener
    const updateProfileButton = document.getElementById("update-profile");
    updateProfileButton.addEventListener("click", async () => {
      updateProfileButton.disabled = true; // Disable button to prevent multiple clicks

      const updatedProfile = {
        avatar: document.getElementById("avatar").src,
        name: document.getElementById("name").value,
        country: document.getElementById("country").value,
        school: document.getElementById("school").value,
        birthday: new Date(document.getElementById("birthday").value).toISOString()
      };

      // Filter out non-updated fields
      const filteredProfile = Object.keys(updatedProfile).reduce((acc, key) => {
        if (key === "avatar" && updatedProfile[key].match(/default-avatar.png/)) {
          delete acc[key];
        } else if (updatedProfile[key] !== profile[key]) {
          acc[key] = updatedProfile[key];
        }
        return acc;
      }, {});

      // Update user profile
      const response = await user.updateProfile(filteredProfile);

      // Notify user of update status
      app.ui.notification(
        "alert",
        response.message,
        response.status === "success" ? "success" : "error",
        document.getElementById("profile"),
        "profile"
      );

      // Redirect to user profile page if successful
      if (response.status === "success") {
        setTimeout(() => {
          app.location.redirect("/user");
        }, 2000);
      }

      updateProfileButton.disabled = false; // Re-enable button
    });
  </script>
</body>

</html>